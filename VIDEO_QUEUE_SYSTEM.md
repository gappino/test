# ุณุณุชู ุตู ฺฉูพุงุฑฺู ูุฏู

## ุฎูุงุตู

ุงู ุณุณุชู ฺฉ ุตู ฺฉูพุงุฑฺู ุจุฑุง ูุฏุฑุช ุณุงุฎุช ููู ุงููุงุน ูุฏููุง (ฺฉูุชุงูุ ุจููุฏุ ุณูุงุฑุด) ุงุฑุงุฆู ูโุฏูุฏ. ูุฏููุง ุจู ุตูุฑุช FIFO (ุงููู ูุฑูุฏุ ุงููู ุฎุฑูุฌ) ูพุฑุฏุงุฒุด ูโุดููุฏ ู ููุท ฺฉ ูุฏู ุฏุฑ ูุฑ ูุญุธู ุณุงุฎุชู ูโุดูุฏ.

## ูฺฺฏโูุง ฺฉูุฏ

### 1. ุตู FIFO ฺฉูพุงุฑฺู
- ููู ุงููุงุน ูุฏู (short/long/custom) ุฏุฑ ฺฉ ุตู ูุงุญุฏ
- ูพุฑุฏุงุฒุด ุจู ุชุฑุชุจ ุฒูุงู ุฏุฑุฎูุงุณุช
- ููุท ฺฉ ูุฏู ุฏุฑ ูุฑ ูุญุธู

### 2. ุฐุฎุฑูโุณุงุฒ ูุถุนุช
- ุฐุฎุฑู ุตู ุฏุฑ `video-queue.json`
- ุฐุฎุฑู ุชุงุฑุฎฺู (ุชุง 50 ุขุชู)
- ุญูุธ ุขูุงุฑ (ููููุ ูุงูููู)

### 3. ุฑุงุจุท ฺฉุงุฑุจุฑ ูุงูุชูุฑูฺฏ
- ููุงุด ุฒูุฏู ูุฏู ุฏุฑ ุญุงู ูพุฑุฏุงุฒุด
- ูุณุช ูุฏููุง ุฏุฑ ุตู ุงูุชุธุงุฑ
- ุชุงุฑุฎฺู ฺฉุงูู ุจุง ููุชุฑ ูุถุนุช
- ุจูโุฑูุฒุฑุณุงู ุฎูุฏฺฉุงุฑ ูุฑ 2 ุซุงูู

### 4. ูุฏุฑุช ฺฉุงูู
- ูุบู ูุฏู ุงุฒ ุตู
- ูพุงฺฉ ฺฉุฑุฏู ุตู
- ูพุงฺฉ ฺฉุฑุฏู ุชุงุฑุฎฺู
- ุขูุงุฑฺฏุฑ ุฏูู

## ูุนูุงุฑ ุณุณุชู

```
Frontend (Any Page)
    โ
    ุฏุฑุฎูุงุณุช ุณุงุฎุช ูุฏู
    โ
routes/video.js
    โ
video-queue-manager.js
    โ
ุตู FIFO (ููุท ฺฉ ูุฏู ููุฒูุงู)
    โ
ุชุงุจุน ุณุงุฎุช ูุฏู
    โ
ูุชุฌู (ูููู/ูุงูููู)
```

## ูุงูโูุง ุฌุฏุฏ

### 1. `video-queue-manager.js`
ูุฏุฑุช ุตู ูุฏููุง ุจุง ูุงุจูุชโูุง:
- `addVideoTask(taskFunction, videoData)` - ุงุถุงูู ฺฉุฑุฏู ูุฏู ุจู ุตู
- `getQueueStatus()` - ุฏุฑุงูุช ูุถุนุช ุตู
- `getHistory(limit)` - ุฏุฑุงูุช ุชุงุฑุฎฺู
- `cancelVideo(videoId)` - ูุบู ูุฏู
- `updateProgress(videoId, progress, step)` - ุจูโุฑูุฒุฑุณุงู ูพุดุฑูุช
- `clearQueue()` - ูพุงฺฉ ฺฉุฑุฏู ุตู
- `clearHistory()` - ูพุงฺฉ ฺฉุฑุฏู ุชุงุฑุฎฺู

### 2. `routes/video-queue.js`
API ูุง ูุงูุชูุฑูฺฏ:
- `GET /api/video-queue/status` - ูุถุนุช ฺฉุงูู ุตู
- `GET /api/video-queue/history` - ุชุงุฑุฎฺู ูุฏููุง
- `POST /api/video-queue/cancel/:videoId` - ูุบู ูุฏู
- `DELETE /api/video-queue/clear` - ูพุงฺฉ ฺฉุฑุฏู ุตู
- `DELETE /api/video-queue/history` - ูพุงฺฉ ฺฉุฑุฏู ุชุงุฑุฎฺู

### 3. `public/video-queue.html`
ุฑุงุจุท ฺฉุงุฑุจุฑ ุจุง ููุงุด:
- ุขูุงุฑ (ุฏุฑ ุญุงู ูพุฑุฏุงุฒุดุ ุฏุฑ ุตูุ ุชฺฉูู ุดุฏูุ ูุงูููู)
- ูุฏู ุฏุฑ ุญุงู ูพุฑุฏุงุฒุด ุจุง progress bar
- ูุณุช ูุฏููุง ุฏุฑ ุตู ุจุง ูุงุจูุช ูุบู
- ุชุงุฑุฎฺู ฺฉุงูู ุจุง badge ูุถุนุช

## ุชุบุฑุงุช ุฏุฑ ูุงูโูุง ููุฌูุฏ

### `routes/video.js`
ุชุบุฑุงุช ุฏุฑ 3 endpoint:

#### 1. `/generate-complete-video` (ูุฏููุง ฺฉูุชุงู)
```javascript
// ูุจู: ุงุฌุฑุง ูุณุชูู
const result = await generateCompleteVideoContent(...);
res.json(result);

// ุจุนุฏ: ุงุถุงูู ุจู ุตู
const videoId = `short-video-${Date.now()}`;
videoQueueManager.addVideoTask(
    async () => await generateCompleteVideoContent(...),
    {
        videoId,
        type: 'short',
        title: script.title,
        metadata: { ... }
    }
);
res.json({ videoId, status: 'queued', ... });
```

#### 2. `/generate-custom-video` (ูุฏููุง ุณูุงุฑุด)
ูุดุงุจู ุจุงูุง ุจุง type: 'custom'

#### 3. `/generate-long-form-video` (ูุฏููุง ุจููุฏ)
```javascript
// ูุจู: ุงุณุชูุงุฏู ุงุฒ resourceManager
resourceManager.addTask(...)

// ุจุนุฏ: ุงุณุชูุงุฏู ุงุฒ videoQueueManager
videoQueueManager.addVideoTask(...)
```

### `server.js`
- ุงุถุงูู ุดุฏู import: `const videoQueueRoutes = require('./routes/video-queue');`
- ุงุถุงูู ุดุฏู route: `app.use('/api/video-queue', videoQueueRoutes);`
- ุงุถุงูู ุดุฏู ุตูุญู: `app.get('/video-queue', ...);`

### `public/ark-menu.js`
- ุงุถุงูู ุดุฏู ููฺฉ "ุตู ูุฏููุง" ุจู ููู

## ูุญูู ุงุณุชูุงุฏู

### ุจุฑุง ฺฉุงุฑุจุฑุงู
1. ูุฏู ุฑุง ุงุฒ ูุฑ ุตูุญูโุง (ฺฉูุชุงู/ุจููุฏ/ุณูุงุฑุด) ุฏุฑุฎูุงุณุช ุฏูุฏ
2. ฺฉ `videoId` ุฏุฑุงูุช ูโฺฉูุฏ ู ูุฏู ุจู ุตู ุงุถุงูู ูโุดูุฏ
3. ุจู ุตูุญู "ุตู ูุฏููุง" ุจุฑูุฏ ุชุง ูพุดุฑูุช ุฑุง ูุดุงูุฏู ฺฉูุฏ
4. ููุช ูุฏู ุขูุงุฏู ุดุฏุ ูโุชูุงูุฏ ุขู ุฑุง ุฏุงูููุฏ ฺฉูุฏ

### ุจุฑุง ุชูุณุนูโุฏููุฏฺฏุงู
```javascript
// ุงุถุงูู ฺฉุฑุฏู ูุฏู ุจู ุตู
const videoQueueManager = require('./video-queue-manager');

videoQueueManager.addVideoTask(
    async () => {
        // ููุทู ุณุงุฎุช ูุฏู
        return { success: true, data: { video_url: '...' } };
    },
    {
        videoId: 'unique-id',
        type: 'short', // ุง 'long' ุง 'custom'
        title: 'ุนููุงู ูุฏู',
        metadata: {
            scenes: 5,
            voice: 'fa_IR-amir-medium',
            // ุณุงุฑ ุงุทูุงุนุงุช...
        }
    }
);

// ุจูโุฑูุฒุฑุณุงู ูพุดุฑูุช (ุงุฎุชุงุฑ)
videoQueueManager.updateProgress('video-id', 50, 'ุชููุฏ ุตุฏุงูุง...');

// ุฏุฑุงูุช ูุถุนุช ุตู
const status = videoQueueManager.getQueueStatus();
console.log(status);
// {
//   activeVideo: { ... },
//   queue: [ ... ],
//   stats: { activeVideos, queuedVideos, processedCount, failedCount }
// }
```

## Event Emitter

ุณุณุชู ุตู ุงุฒ EventEmitter ุงุณุชูุงุฏู ูโฺฉูุฏ:

```javascript
videoQueueManager.on('videoAdded', (data) => {
    console.log('Video added:', data.videoId);
});

videoQueueManager.on('videoStarted', (data) => {
    console.log('Video started:', data.videoId);
});

videoQueueManager.on('videoCompleted', (data) => {
    console.log('Video completed:', data.videoId);
});

videoQueueManager.on('videoFailed', (data) => {
    console.error('Video failed:', data.videoId, data.error);
});

videoQueueManager.on('progressUpdate', (data) => {
    console.log('Progress:', data.videoId, data.progress + '%');
});
```

## ุณุงุฎุชุงุฑ ุฏุงุฏู

### Video Object
```javascript
{
    id: 'video-123',
    type: 'short', // ุง 'long', 'custom'
    title: 'ุนููุงู ูุฏู',
    status: 'pending', // ุง 'processing', 'completed', 'failed', 'cancelled'
    progress: 0-100,
    addedTime: 1234567890,
    startTime: 1234567890,
    endTime: 1234567890,
    metadata: {
        scenes: 5,
        voice: 'fa_IR-amir-medium',
        backgroundMusic: 'music.mp3',
        // ุณุงุฑ ููุฏูุง...
    },
    error: null // ุง ุฑุดุชู ุฎุทุง
}
```

### Queue Status Response
```javascript
{
    success: true,
    data: {
        activeVideo: { ... }, // ุง null
        queue: [ ... ], // ุขุฑุงู ูุฏููุง ุฏุฑ ุงูุชุธุงุฑ
        stats: {
            activeVideos: 1,
            queuedVideos: 3,
            processedCount: 10,
            failedCount: 2,
            totalVideos: 16
        }
    }
}
```

## ูุฒุงุง

### 1. ุฌููฺฏุฑ ุงุฒ ูุดุงุฑ ููุงุจุน
- ููุท ฺฉ ูุฏู ุฏุฑ ูุฑ ูุญุธู ูพุฑุฏุงุฒุด ูโุดูุฏ
- CPU/RAM ุจู ุตูุฑุช ฺฉูุชุฑู ุดุฏู ุงุณุชูุงุฏู ูโุดูุฏ
- ุณุณุชู ูพุงุฏุงุฑ ู ุจุฏูู ฺฉุฑุด

### 2. ุนุฏุงูุช ุฏุฑ ูพุฑุฏุงุฒุด
- ุชูุงู ุฏุฑุฎูุงุณุชโูุง ุจู ุชุฑุชุจ FIFO
- ูฺ ูุฏู ุงุฒ ุฏฺฏุฑ ุฌูู ููโุฒูุฏ
- ฺฉุงุฑุจุฑุงู ูโุฏุงููุฏ ฺู ุฒูุงู ููุจุช ุขููุงุณุช

### 3. ุดูุงูุช ฺฉุงูู
- ููุงุด ุฒูุฏู ูุถุนุช
- ูพุดุฑูุช ุฏูู ูุฑ ูุฏู
- ุชุงุฑุฎฺู ฺฉุงูู

### 4. ูุฏุฑุช ุขุณุงู
- ูุบู ูุฏููุง ุงุฒ ุตู
- ูพุงฺฉ ฺฉุฑุฏู ุตู ุฏุฑ ุตูุฑุช ูุงุฒ
- ุขูุงุฑฺฏุฑ ุฏูู

## ุชูุงูุช ุจุง ุณุณุชู ูุจู

### ูุจู:
- โ ูุฏููุง ฺฉูุชุงู ู ุณูุงุฑุด ุจุฏูู ุตู
- โ ููุท ูุฏููุง ุจููุฏ ุงุฒ `resourceManager` ุงุณุชูุงุฏู ูโฺฉุฑุฏูุฏ
- โ ุนุฏู ููุงููฺฏ ุจู ุงููุงุน ูุฎุชูู ูุฏู
- โ ุงุญุชูุงู ุงุฌุฑุง ููุฒูุงู ฺูุฏ ูุฏู

### ุจุนุฏ:
- โ ููู ูุฏููุง ุฏุฑ ฺฉ ุตู ฺฉูพุงุฑฺู
- โ ููุท ฺฉ ูุฏู ุฏุฑ ูุฑ ูุญุธู
- โ ุงููุช FIFO ุจุฑุง ููู
- โ ุฑุงุจุท ฺฉุงุฑุจุฑ ูุงูุชูุฑูฺฏ

## ุนููฺฉุฑุฏ

- **ุชุนุฏุงุฏ ููุฒูุงู**: 1 ูุฏู
- **ุงูฺฏูุฑุชู ุตู**: FIFO
- **ุญุฏุงฺฉุซุฑ ุชุงุฑุฎฺู**: 50 ุขุชู
- **ุจูโุฑูุฒุฑุณุงู UI**: ูุฑ 2 ุซุงูู
- **ุฐุฎุฑูโุณุงุฒ**: `video-queue.json`

## ูฺฉุงุช ููู

1. **ุณุงุฒฺฏุงุฑ ุจุง ฺฉุฏ ูุฏู**: ฺฉุฏ frontend ูุฏู ููฺูุงู ฺฉุงุฑ ูโฺฉูุฏุ ููุท ุจู ุฌุง ูุชุฌู ููุฑุ `videoId` ุฏุฑุงูุช ูโฺฉูุฏ

2. **Persistence**: ุตู ุฏุฑ ูุงู ุฐุฎุฑู ูโุดูุฏุ ุงูุง tasks ูุนุงู ุฏุฑ restart ุงุฒ ุฏุณุช ูโุฑููุฏ

3. **Error Handling**: ุฎุทุงูุง ุซุจุช ูโุดููุฏ ู ูุฏู ุจู ุชุงุฑุฎฺู ุจุง ูุถุนุช 'failed' ุงุถุงูู ูโุดูุฏ

4. **Cancellation**: ููุท ูุฏููุง ุฏุฑ ุตู ูุงุจู ูุบู ูุณุชูุฏุ ูู ูุฏู ุฏุฑ ุญุงู ูพุฑุฏุงุฒุด

## ุชูุณุนู ุขูุฏู

ูพุดููุงุฏุงุช ุจุฑุง ุจูุจูุฏ:

- [ ] ุงุถุงูู ฺฉุฑุฏู ุงููุช ุฏุณุช ุจู ูุฏููุง
- [ ] ูพุดุชุจุงู ุงุฒ pause/resume
- [ ] WebSocket ุจุฑุง ุจูโุฑูุฒุฑุณุงู real-time
- [ ] ููุชูฺฉุดู ููฺฏุงู ุชฺฉูู ูุฏู
- [ ] ุตูโูุง ุฌุฏุงฺฏุงูู ุจุฑุง ูุฑ ฺฉุงุฑุจุฑ
- [ ] ูุญุฏูุฏุช ุชุนุฏุงุฏ ูุฏู ุฏุฑ ุตู
- [ ] ุชุฎูู ุฒูุงู ุงูุชุธุงุฑ

## ุชุณุช

ุจุฑุง ุชุณุช ุณุณุชู:

1. ุณุฑูุฑ ุฑุง ุงุฌุฑุง ฺฉูุฏ: `node server.js`
2. ฺูุฏ ูุฏู (ฺฉูุชุงูุ ุจููุฏุ ุณูุงุฑุด) ุจุณุงุฒุฏ
3. ุจู `/video-queue` ุจุฑูุฏ
4. ูุดุงูุฏู ฺฉูุฏ ฺฉู ูุฏููุง ุจู ุชุฑุชุจ ูพุฑุฏุงุฒุด ูโุดููุฏ
5. ฺฉ ูุฏู ุฑุง ูุบู ฺฉูุฏ
6. ุตู ุฑุง ูพุงฺฉ ฺฉูุฏ

## ูพุดุชุจุงู

ุฏุฑ ุตูุฑุช ูุดฺฉูุ ูุงฺฏโูุง ุฑุง ุจุฑุฑุณ ฺฉูุฏ:
```
๐น [Video Queue] Added "..." to queue
๐ [Video Queue] Starting "..."
โ [Video Queue] Completed "..." in Xs
๐ [Video Queue] Current Status: ...
```

---

**ุชุงุฑุฎ ูพุงุฏูโุณุงุฒ**: 2025-10-10  
**ูุณุฎู**: 1.0.0  
**ูุถุนุช**: โ ฺฉุงูู ู ุขูุงุฏู ุงุณุชูุงุฏู

