<!DOCTYPE html>
<html lang="fa" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#3b82f6">
    <title>ارک پلاس - ساخت ویدیو سفارشی</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background: linear-gradient(135deg, hsl(220, 40%, 5%) 0%, hsl(220, 40%, 8%) 50%, hsl(220, 40%, 5%) 100%);
            min-height: 100vh;
            padding: 20px;
            color: hsl(210, 40%, 98%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(71, 85, 105, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(168, 85, 247, 0.2));
            backdrop-filter: blur(20px);
            color: hsl(210, 40%, 98%);
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        /* Steps Indicator */
        .steps-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }

        .steps-indicator::before {
            content: '';
            position: absolute;
            top: 25px;
            left: 50px;
            right: 50px;
            height: 3px;
            background: rgba(71, 85, 105, 0.3);
            z-index: 0;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(71, 85, 105, 0.3);
            color: rgba(226, 232, 240, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .step.active .step-circle {
            background: linear-gradient(135deg, hsl(217, 91%, 60%), rgba(59, 130, 246, 0.8));
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
        }

        .step.completed .step-circle {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);
        }

        .step-label {
            font-size: 0.9rem;
            color: rgba(226, 232, 240, 0.7);
        }

        .step.active .step-label {
            color: hsl(217, 91%, 60%);
            font-weight: 600;
        }

        /* Form Sections */
        .form-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .form-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 2rem;
            color: hsl(210, 40%, 98%);
            margin-bottom: 30px;
            text-align: center;
        }

        /* Scene Management */
        .scenes-container {
            margin-bottom: 30px;
        }

        .scene-item {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(71, 85, 105, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            position: relative;
        }

        .scene-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .scene-number {
            background: linear-gradient(135deg, hsl(217, 91%, 60%), rgba(59, 130, 246, 0.8));
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
        }

        .remove-scene-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-family: 'Vazirmatn', sans-serif;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        }

        .remove-scene-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.6);
        }

        .add-scene-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            font-family: 'Vazirmatn', sans-serif;
            width: 100%;
            margin-top: 20px;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);
        }

        .add-scene-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.6);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: hsl(210, 40%, 98%);
            font-size: 1rem;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(71, 85, 105, 0.3);
            border-radius: 10px;
            font-size: 15px;
            font-family: 'Vazirmatn', sans-serif;
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            color: hsl(210, 40%, 98%);
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: hsl(217, 91%, 60%);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Voice Selection */
        .voice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .voice-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            border: 3px solid rgba(71, 85, 105, 0.3);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .voice-card:hover {
            border-color: hsl(217, 91%, 60%);
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        .voice-card.selected {
            border-color: hsl(217, 91%, 60%);
            background: rgba(59, 130, 246, 0.1);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }

        .voice-card h3 {
            color: hsl(210, 40%, 98%);
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .voice-card p {
            color: rgba(226, 232, 240, 0.7);
            font-size: 0.95rem;
        }

        .voice-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        /* Orientation Selection */
        .orientation-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .orientation-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            border: 3px solid rgba(71, 85, 105, 0.3);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .orientation-card:hover {
            border-color: hsl(217, 91%, 60%);
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        .orientation-card.selected {
            border-color: hsl(217, 91%, 60%);
            background: rgba(59, 130, 246, 0.1);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }

        .orientation-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .orientation-card h3 {
            color: hsl(210, 40%, 98%);
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .orientation-card p {
            color: rgba(226, 232, 240, 0.7);
            font-size: 0.95rem;
        }

        /* Subtitle Customization */
        .subtitle-controls {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        .subtitle-controls h3 {
            color: hsl(210, 40%, 98%);
            margin-bottom: 20px;
        }

        .control-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: hsl(210, 40%, 98%);
        }

        .control-group input {
            padding: 10px;
            border: 2px solid rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Vazirmatn', sans-serif;
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            color: hsl(210, 40%, 98%);
        }

        .subtitle-preview {
            background: rgba(15, 23, 42, 0.8);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            position: relative;
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        .subtitle-text {
            font-size: 24px;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 5px;
            display: inline-block;
            transition: all 0.3s ease;
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            font-family: 'Vazirmatn', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, hsl(217, 91%, 60%), rgba(168, 85, 247, 0.8));
            color: white;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.6);
        }

        .btn-secondary {
            background: rgba(71, 85, 105, 0.6);
            backdrop-filter: blur(10px);
            color: white;
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn:disabled {
            background: rgba(71, 85, 105, 0.5);
            cursor: not-allowed;
            transform: none;
            opacity: 0.5;
        }

        /* Status Messages */
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: 600;
            text-align: center;
            font-family: 'Vazirmatn', sans-serif;
        }

        .status.success { 
            background: rgba(16, 185, 129, 0.2); 
            color: #10b981; 
            border: 1px solid rgba(16, 185, 129, 0.3); 
        }
        .status.error { 
            background: rgba(239, 68, 68, 0.2); 
            color: #ef4444; 
            border: 1px solid rgba(239, 68, 68, 0.3); 
        }
        .status.info { 
            background: rgba(59, 130, 246, 0.2); 
            color: hsl(217, 91%, 60%); 
            border: 1px solid rgba(59, 130, 246, 0.3); 
        }
        .status.loading { 
            background: rgba(245, 158, 11, 0.2); 
            color: #f59e0b; 
            border: 1px solid rgba(245, 158, 11, 0.3); 
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(71, 85, 105, 0.3);
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, hsl(217, 91%, 60%), rgba(168, 85, 247, 0.8));
            width: 0%;
            transition: width 0.3s ease;
        }

        .video-result {
            margin-top: 30px;
            text-align: center;
            padding: 30px;
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        video {
            max-width: 100%;
            height: auto;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        /* Responsive Design for Mobile */
        @media (max-width: 768px) {
            /* جلوگیری از اسکرول افقی */
            * {
                max-width: 100vw;
            }
            
            body {
                padding: 10px;
                overflow-x: hidden;
            }
            
            .container {
                max-width: 100vw;
                padding: 0;
                margin: 0;
            }
            
            .header {
                padding: 15px;
                border-radius: 15px 15px 0 0;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .header p {
                font-size: 0.9rem;
            }
            
            .content {
                padding: 15px;
            }
            
            /* Steps Indicator - Vertical Layout */
            .steps-indicator {
                flex-direction: column;
                gap: 10px;
                margin-bottom: 30px;
            }
            
            .steps-indicator::before {
                display: none;
            }
            
            .step {
                display: flex;
                align-items: center;
                gap: 12px;
                text-align: right;
                background: rgba(30, 41, 59, 0.4);
                backdrop-filter: blur(10px);
                padding: 12px;
                border-radius: 12px;
                border: 2px solid rgba(71, 85, 105, 0.3);
            }
            
            .step.active {
                border-color: hsl(217, 91%, 60%);
                background: rgba(59, 130, 246, 0.1);
            }
            
            .step.completed {
                border-color: #10b981;
                background: rgba(16, 185, 129, 0.1);
            }
            
            .step-circle {
                width: 40px;
                height: 40px;
                font-size: 1rem;
                flex-shrink: 0;
            }
            
            .step-label {
                flex: 1;
                text-align: right;
                font-size: 0.9rem;
            }
            
            /* Section Title */
            .section-title {
                font-size: 1.3rem;
            }
            
            /* Scene Management */
            .scene-item {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .scene-header {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .scene-number {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
            
            .remove-scene-btn {
                width: 100%;
                margin-top: 10px;
                font-size: 0.85rem;
                padding: 8px 12px;
            }
            
            .add-scene-btn {
                padding: 12px 20px;
                font-size: 0.9rem;
            }
            
            .form-group label {
                font-size: 0.9rem;
            }
            
            .form-group input,
            .form-group textarea {
                font-size: 0.85rem;
                padding: 10px;
            }
            
            /* Voice Selection - Single Column */
            .voice-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .voice-card {
                padding: 15px;
            }
            
            .voice-card h3 {
                font-size: 1.1rem;
            }
            
            .voice-card p {
                font-size: 0.85rem;
            }
            
            .voice-icon {
                font-size: 2rem;
            }
            
            /* Orientation Cards */
            .orientation-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .orientation-card {
                padding: 20px;
            }
            
            .orientation-card h3 {
                font-size: 1.1rem;
            }
            
            .orientation-card p {
                font-size: 0.85rem;
            }
            
            .orientation-icon {
                font-size: 3rem;
            }
            
            /* Subtitle Controls */
            .subtitle-controls {
                padding: 15px;
            }
            
            .subtitle-controls h3 {
                font-size: 1.1rem;
            }
            
            .control-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .control-group label {
                font-size: 0.85rem;
            }
            
            .control-group input {
                padding: 8px;
                font-size: 0.85rem;
            }
            
            .subtitle-preview {
                padding: 20px;
                min-height: 150px;
            }
            
            .subtitle-text {
                font-size: 18px;
            }
            
            /* Button Group - Vertical */
            .button-group {
                flex-direction: column;
                gap: 10px;
                width: 100%;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 0.9rem;
                width: 100%;
                min-height: 44px;
            }
            
            /* Summary Container */
            #summaryContainer {
                max-width: 100%;
                padding: 0 10px;
            }
            
            #summaryContainer > div {
                padding: 12px;
                font-size: 0.85rem;
            }
            
            /* Status and Progress */
            .status {
                padding: 12px;
                font-size: 0.85rem;
            }
            
            .progress-bar {
                margin: 15px 0;
            }
            
            /* Video Result */
            .video-result {
                padding: 15px;
            }
            
            video {
                border-radius: 10px;
            }
        }
        
        /* موبایل‌های خیلی کوچک */
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .header h1 {
                font-size: 1.3rem;
            }
            
            .content {
                padding: 10px;
            }
            
            .section-title {
                font-size: 1.1rem;
            }
            
            .scene-item {
                padding: 12px;
            }
            
            .voice-card,
            .orientation-card {
                padding: 12px;
            }
            
            .subtitle-controls {
                padding: 12px;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 0.85rem;
            }
            
            .subtitle-text {
                font-size: 16px;
            }
            
            .step {
                padding: 10px;
            }
            
            .step-circle {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
            
            .step-label {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎬 ارک پلاس - ساخت ویدیو سفارشی</h1>
            <p>ویدیوی خود را گام به گام بسازید</p>
        </div>

        <div class="content">
            <!-- Steps Indicator -->
            <div class="steps-indicator">
                <div class="step active" data-step="1">
                    <div class="step-circle">1</div>
                    <div class="step-label">صحنه‌های ویدیو</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-circle">2</div>
                    <div class="step-label">انتخاب صدا</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-circle">3</div>
                    <div class="step-label">تنظیمات نمایش</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-circle">4</div>
                    <div class="step-label">ساخت ویدیو</div>
                </div>
            </div>

            <!-- Step 1: Scenes -->
            <div class="form-section active" id="step1">
                <h2 class="section-title">📝 مرحله 1: صحنه‌های ویدیو</h2>
                
                <div class="scenes-container" id="scenesContainer">
                    <!-- Scene 1 -->
                    <div class="scene-item" data-scene-index="0">
                        <div class="scene-header">
                            <div class="scene-number">1</div>
                            <button type="button" class="remove-scene-btn" onclick="removeScene(0)" style="display: none;">حذف صحنه</button>
                        </div>
                        
                        <div class="form-group">
                            <label>متن گوینده:</label>
                            <textarea class="scene-text" placeholder="متن مورد نظر خود را وارد کنید...">آیا می‌دانستید که هوش مصنوعی در حال تغییر دنیای ما است؟</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>پرامپت تصویر (به انگلیسی):</label>
                            <input type="text" class="scene-prompt" placeholder="توضیح تصویر به انگلیسی..." value="futuristic AI city with advanced technology and glowing elements, cinematic lighting, 4k quality">
                        </div>
                    </div>
                </div>

                <button type="button" class="add-scene-btn" onclick="addScene()">➕ اضافه کردن صحنه جدید</button>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="nextStep(1)">بعدی ➡️</button>
                </div>
            </div>

            <!-- Step 2: Voice Selection -->
            <div class="form-section" id="step2">
                <h2 class="section-title">🎤 مرحله 2: انتخاب صدا</h2>
                
                <p style="text-align: center; margin-bottom: 30px; color: #666;">
                    صدای مورد نظر خود را انتخاب کنید
                </p>

                <div id="voiceContainer">
                    <!-- Persian Voices -->
                    <h3 style="color: #333; margin-bottom: 20px;">صداهای فارسی</h3>
                    <div class="voice-grid" id="persianVoices">
                        <div class="voice-card" data-voice="fa_IR-amir-medium" data-lang="persian">
                            <div class="voice-icon">👨</div>
                            <h3>امیر</h3>
                            <p>صدای مرد فارسی - طبیعی و واضح</p>
                        </div>
                        <div class="voice-card" data-voice="fa_IR-ganji-medium" data-lang="persian">
                            <div class="voice-icon">👨</div>
                            <h3>گنجی</h3>
                            <p>صدای مرد فارسی - با کیفیت بالا</p>
                        </div>
                        <div class="voice-card" data-voice="fa_IR-ganji_adabi-medium" data-lang="persian">
                            <div class="voice-icon">👨</div>
                            <h3>گنجی ادبی</h3>
                            <p>صدای مرد فارسی - ادبی</p>
                        </div>
                        <div class="voice-card" data-voice="fa_IR-gyro-medium" data-lang="persian">
                            <div class="voice-icon">🎯</div>
                            <h3>جیرو</h3>
                            <p>صدای مرد فارسی - انرژی بالا</p>
                        </div>
                        <div class="voice-card" data-voice="fa_IR-reza_ibrahim-medium" data-lang="persian">
                            <div class="voice-icon">👨</div>
                            <h3>رضا ابراهیم</h3>
                            <p>صدای مرد فارسی - طبیعی</p>
                        </div>
                    </div>

                    <!-- English Female Voices -->
                    <h3 style="color: #333; margin: 30px 0 20px 0;">صداهای زن انگلیسی</h3>
                    <div class="voice-grid" id="englishFemaleVoices">
                        <div class="voice-card" data-voice="en_US-kristin-medium" data-lang="english">
                            <div class="voice-icon">👩</div>
                            <h3>Kristin</h3>
                            <p>صدای زن انگلیسی - طبیعی</p>
                        </div>
                        <div class="voice-card" data-voice="en_US-lessac-high" data-lang="english">
                            <div class="voice-icon">👩</div>
                            <h3>Lessac High</h3>
                            <p>صدای زن انگلیسی - با کیفیت بالا</p>
                        </div>
                    </div>

                    <!-- English Male Voices -->
                    <h3 style="color: #333; margin: 30px 0 20px 0;">صداهای مرد انگلیسی</h3>
                    <div class="voice-grid" id="englishMaleVoices">
                        <div class="voice-card" data-voice="en_US-john-medium" data-lang="english">
                            <div class="voice-icon">👨</div>
                            <h3>John</h3>
                            <p>صدای مرد انگلیسی - طبیعی</p>
                        </div>
                        <div class="voice-card" data-voice="en_US-ryan-high" data-lang="english">
                            <div class="voice-icon">👨</div>
                            <h3>Ryan High</h3>
                            <p>صدای مرد انگلیسی - باکیفیت</p>
                        </div>
                        <div class="voice-card" data-voice="en_US-norman-medium" data-lang="english">
                            <div class="voice-icon">👨</div>
                            <h3>Norman</h3>
                            <p>صدای مرد انگلیسی - طبیعی</p>
                        </div>
                        <div class="voice-card" data-voice="en_US-kusal-medium" data-lang="english">
                            <div class="voice-icon">👨</div>
                            <h3>Kusal</h3>
                            <p>صدای مرد انگلیسی - طبیعی</p>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="previousStep(2)">⬅️ قبلی</button>
                    <button class="btn btn-primary" onclick="nextStep(2)">بعدی ➡️</button>
                </div>
            </div>

            <!-- Step 3: Orientation and Subtitle Customization -->
            <div class="form-section" id="step3">
                <h2 class="section-title">⚙️ مرحله 3: تنظیمات نمایش</h2>
                
                <!-- Orientation Selection -->
                <h3 style="color: hsl(210, 40%, 98%); margin-bottom: 20px;">جهت ویدیو</h3>
                <div class="orientation-grid">
                    <div class="orientation-card selected" data-orientation="vertical">
                        <div class="orientation-icon">📱</div>
                        <h3>عمودی (Vertical)</h3>
                        <p>1080 × 1920 - مناسب برای موبایل</p>
                    </div>
                    <div class="orientation-card" data-orientation="horizontal">
                        <div class="orientation-icon">🖥️</div>
                        <h3>افقی (Horizontal)</h3>
                        <p>1920 × 1080 - مناسب برای دسکتاپ</p>
                    </div>
                </div>

                <!-- Background Music Selection -->
                <h3 style="color: hsl(210, 40%, 98%); margin-bottom: 20px;">🎵 انتخاب موزیک بک‌گراند</h3>
                <div style="background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(10px); padding: 25px; border-radius: 15px; margin-bottom: 30px; border: 1px solid rgba(71, 85, 105, 0.3);">
                    <div class="form-group">
                        <label for="customBackgroundMusic">موزیک بک‌گراند:</label>
                        <select id="customBackgroundMusic" class="form-group input" style="width: 100%; padding: 12px; border: 2px solid rgba(71, 85, 105, 0.3); border-radius: 10px; font-size: 15px; font-family: 'Vazirmatn', sans-serif; background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(10px); color: hsl(210, 40%, 98%);">
                            <option value="">بدون موزیک بک‌گراند</option>
                            <!-- موزیک‌ها به صورت داینامیک بارگذاری می‌شوند -->
                        </select>
                    </div>
                    <div id="musicPreview" style="margin-top: 15px; display: none;">
                        <audio controls style="width: 100%;" id="musicPreviewPlayer">
                            مرورگر شما از پخش صدا پشتیبانی نمی‌کند.
                        </audio>
                    </div>
                </div>

                <!-- Subtitle Customization -->
                <div class="subtitle-controls">
                    <h3>🎨 سفارشی‌سازی زیرنویس</h3>
                    
                    <div class="control-row">
                        <div class="control-group">
                            <label>رنگ متن:</label>
                            <input type="color" id="subtitleColor" value="#ffffff">
                        </div>
                        <div class="control-group">
                            <label>سایز فونت:</label>
                            <input type="number" id="subtitleSize" value="24" min="16" max="48">
                        </div>
                        <div class="control-group">
                            <label>ضخامت حاشیه:</label>
                            <input type="number" id="subtitleOutline" value="2" min="1" max="5">
                        </div>
                    </div>

                    <!-- Preview -->
                    <h4 style="margin-top: 20px; margin-bottom: 10px;">پیش‌نمایش زیرنویس:</h4>
                    <div class="subtitle-preview">
                        <span class="subtitle-text" id="subtitlePreviewFa">متن نمونه زیرنویس فارسی</span>
                        <span class="subtitle-text" id="subtitlePreviewEn">Sample English Subtitle Text</span>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="previousStep(3)">⬅️ قبلی</button>
                    <button class="btn btn-primary" onclick="nextStep(3)">بعدی ➡️</button>
                </div>
            </div>

            <!-- Step 4: Generate Video -->
            <div class="form-section" id="step4">
                <h2 class="section-title">🚀 مرحله 4: آماده ساخت ویدیو</h2>
                
                <div style="background: #f8f9fa; padding: 30px; border-radius: 15px; text-align: center;">
                    <h3 style="color: #333; margin-bottom: 20px;">خلاصه تنظیمات شما</h3>
                    
                    <div id="summaryContainer" style="text-align: right; max-width: 600px; margin: 0 auto;">
                        <!-- Summary will be inserted here -->
                    </div>

                    <div class="button-group" style="margin-top: 40px;">
                        <button class="btn btn-secondary" onclick="previousStep(4)">⬅️ قبلی</button>
                        <button class="btn btn-primary" onclick="generateVideo()" id="generateBtn">
                            🎬 ساخت ویدیو نهایی
                        </button>
                    </div>
                </div>
            </div>

            <!-- Status and Progress -->
            <div id="status"></div>
            <div id="progressContainer" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p id="progressText" style="text-align: center; margin-top: 10px;">در حال پردازش...</p>
            </div>
            <div id="videoResult" class="video-result"></div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let selectedVoice = null;
        let selectedOrientation = 'vertical';
        let sceneCount = 1;
        let subtitleSettings = {
            color: '#ffffff',
            size: 24,
            outline: 2
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Load background music options
            loadBackgroundMusic();
            
            // Voice selection
            document.querySelectorAll('.voice-card').forEach(card => {
                card.addEventListener('click', function() {
                    document.querySelectorAll('.voice-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedVoice = this.dataset.voice;
                    console.log('Selected voice:', selectedVoice);
                });
            });

            // Orientation selection
            document.querySelectorAll('.orientation-card').forEach(card => {
                card.addEventListener('click', function() {
                    document.querySelectorAll('.orientation-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedOrientation = this.dataset.orientation;
                    console.log('Selected orientation:', selectedOrientation);
                });
            });

            // Background music selection
            document.getElementById('customBackgroundMusic').addEventListener('change', function() {
                const selectedMusic = this.value;
                const musicPreview = document.getElementById('musicPreview');
                const musicPreviewPlayer = document.getElementById('musicPreviewPlayer');
                
                if (selectedMusic && selectedMusic.trim() !== '') {
                    musicPreview.style.display = 'block';
                    musicPreviewPlayer.src = `/api/music/files/${selectedMusic}`;
                } else {
                    musicPreview.style.display = 'none';
                    musicPreviewPlayer.src = '';
                }
            });

            // Subtitle customization listeners
            document.getElementById('subtitleColor').addEventListener('input', updateSubtitlePreview);
            document.getElementById('subtitleSize').addEventListener('input', updateSubtitlePreview);
            document.getElementById('subtitleOutline').addEventListener('input', updateSubtitlePreview);
            
            updateSubtitlePreview();
        });

        // Load background music options
        async function loadBackgroundMusic() {
            try {
                console.log('🎵 Loading custom video background music options...');
                const response = await fetch('/api/music/list');
                const data = await response.json();
                
                console.log('🎵 Custom video API response:', data);
                
                const backgroundMusicSelect = document.getElementById('customBackgroundMusic');
                console.log('🎵 customBackgroundMusic element:', backgroundMusicSelect);
                
                if (data.success && backgroundMusicSelect) {
                    // Clear existing options except the first one
                    backgroundMusicSelect.innerHTML = '<option value="">بدون موزیک بک‌گراند</option>';
                    
                    // Group music by category
                    const categories = {};
                    data.music.forEach(music => {
                        if (!categories[music.type]) {
                            categories[music.type] = [];
                        }
                        categories[music.type].push(music);
                    });
                    
                    // Add music options grouped by category
                    Object.entries(categories).forEach(([category, musicList]) => {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = `🎵 ${category}`;
                        
                        musicList.forEach(music => {
                            const option = document.createElement('option');
                            option.value = music.filename;
                            option.textContent = music.name;
                            optgroup.appendChild(option);
                        });
                        
                        backgroundMusicSelect.appendChild(optgroup);
                    });
                    
                    console.log('✅ Custom video background music options loaded:', data.music.length);
                } else {
                    console.error('❌ Failed to load custom video background music:', data);
                    console.error('❌ customBackgroundMusic element:', backgroundMusicSelect);
                }
            } catch (error) {
                console.error('❌ Error loading custom video background music:', error);
            }
        }

        function updateSubtitlePreview() {
            const previewFa = document.getElementById('subtitlePreviewFa');
            const previewEn = document.getElementById('subtitlePreviewEn');
            const color = document.getElementById('subtitleColor').value;
            const size = document.getElementById('subtitleSize').value;
            const outline = document.getElementById('subtitleOutline').value;

            // Update settings object
            subtitleSettings = {
                color,
                size: parseInt(size),
                outline: parseInt(outline)
            };

            const textShadow = `
                -${outline}px -${outline}px 0 #000,
                ${outline}px -${outline}px 0 #000,
                -${outline}px ${outline}px 0 #000,
                ${outline}px ${outline}px 0 #000
            `;

            [previewFa, previewEn].forEach(preview => {
                preview.style.color = color;
                preview.style.fontSize = size + 'px';
                preview.style.textShadow = textShadow;
                preview.style.fontFamily = 'Arial';
            });
        }

        function addScene() {
            sceneCount++;
            const container = document.getElementById('scenesContainer');
            const newScene = document.createElement('div');
            newScene.className = 'scene-item';
            newScene.dataset.sceneIndex = sceneCount - 1;
            
            newScene.innerHTML = `
                <div class="scene-header">
                    <div class="scene-number">${sceneCount}</div>
                    <button type="button" class="remove-scene-btn" onclick="removeScene(${sceneCount - 1})">حذف صحنه</button>
                </div>
                
                <div class="form-group">
                    <label>متن گوینده:</label>
                    <textarea class="scene-text" placeholder="متن مورد نظر خود را وارد کنید..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>پرامپت تصویر (به انگلیسی):</label>
                    <input type="text" class="scene-prompt" placeholder="توضیح تصویر به انگلیسی...">
                </div>
            `;
            
            container.appendChild(newScene);
            
            // Show remove buttons
            if (sceneCount > 1) {
                document.querySelectorAll('.remove-scene-btn').forEach(btn => {
                    btn.style.display = 'block';
                });
            }
        }

        function removeScene(index) {
            const scenes = document.querySelectorAll('.scene-item');
            if (scenes.length <= 1) {
                alert('حداقل یک صحنه باید وجود داشته باشد');
                return;
            }
            
            scenes[index].remove();
            sceneCount--;
            
            // Update scene numbers
            document.querySelectorAll('.scene-item').forEach((item, idx) => {
                item.dataset.sceneIndex = idx;
                item.querySelector('.scene-number').textContent = idx + 1;
                const removeBtn = item.querySelector('.remove-scene-btn');
                removeBtn.setAttribute('onclick', `removeScene(${idx})`);
            });
            
            // Hide remove buttons if only one scene
            if (sceneCount === 1) {
                document.querySelectorAll('.remove-scene-btn').forEach(btn => {
                    btn.style.display = 'none';
                });
            }
        }

        function nextStep(step) {
            // Validate current step
            if (step === 1) {
                const scenes = document.querySelectorAll('.scene-item');
                let valid = true;
                scenes.forEach(scene => {
                    const text = scene.querySelector('.scene-text').value.trim();
                    const prompt = scene.querySelector('.scene-prompt').value.trim();
                    if (!text || !prompt) {
                        valid = false;
                    }
                });
                
                if (!valid) {
                    showStatus('لطفاً تمام فیلدهای صحنه‌ها را پر کنید', 'error');
                    return;
                }
            } else if (step === 2) {
                if (!selectedVoice) {
                    showStatus('لطفاً یک صدا انتخاب کنید', 'error');
                    return;
                }
            }

            // Move to next step
            document.getElementById('step' + step).classList.remove('active');
            document.getElementById('step' + (step + 1)).classList.add('active');
            
            // Update steps indicator
            document.querySelector(`.step[data-step="${step}"]`).classList.add('completed');
            document.querySelector(`.step[data-step="${step}"]`).classList.remove('active');
            document.querySelector(`.step[data-step="${step + 1}"]`).classList.add('active');
            
            currentStep = step + 1;

            // If moving to step 4, show summary
            if (step === 3) {
                showSummary();
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function previousStep(step) {
            document.getElementById('step' + step).classList.remove('active');
            document.getElementById('step' + (step - 1)).classList.add('active');
            
            // Update steps indicator
            document.querySelector(`.step[data-step="${step}"]`).classList.remove('active');
            document.querySelector(`.step[data-step="${step - 1}"]`).classList.remove('completed');
            document.querySelector(`.step[data-step="${step - 1}"]`).classList.add('active');
            
            currentStep = step - 1;

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showSummary() {
            const scenes = Array.from(document.querySelectorAll('.scene-item'));
            const voiceName = document.querySelector('.voice-card.selected h3').textContent;
            const orientationName = selectedOrientation === 'vertical' ? 'عمودی (موبایل)' : 'افقی (دسکتاپ)';

            let scenesHtml = '';
            scenes.forEach((scene, idx) => {
                const text = scene.querySelector('.scene-text').value;
                const prompt = scene.querySelector('.scene-prompt').value;
                scenesHtml += `
                    <div style="background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(10px); padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid rgba(71, 85, 105, 0.3);">
                        <strong style="color: hsl(210, 40%, 98%);">صحنه ${idx + 1}:</strong>
                        <p style="color: rgba(226, 232, 240, 0.7); margin-top: 5px; font-size: 0.9rem;">${text.substring(0, 50)}${text.length > 50 ? '...' : ''}</p>
                        <p style="color: rgba(226, 232, 240, 0.5); margin-top: 5px; font-size: 0.85rem;">🖼️ ${prompt.substring(0, 40)}${prompt.length > 40 ? '...' : ''}</p>
                    </div>
                `;
            });

            const summary = `
                ${scenesHtml}
                <div style="background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(10px); padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 1px solid rgba(71, 85, 105, 0.3);">
                    <strong style="color: hsl(210, 40%, 98%);">🎤 صدای انتخابی:</strong>
                    <p style="color: rgba(226, 232, 240, 0.7); margin-top: 5px;">${voiceName}</p>
                </div>
                <div style="background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(10px); padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 1px solid rgba(71, 85, 105, 0.3);">
                    <strong style="color: hsl(210, 40%, 98%);">📐 جهت ویدیو:</strong>
                    <p style="color: rgba(226, 232, 240, 0.7); margin-top: 5px;">${orientationName}</p>
                </div>
                <div style="background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(10px); padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 1px solid rgba(71, 85, 105, 0.3);">
                    <strong style="color: hsl(210, 40%, 98%);">🎵 موزیک بک‌گراند:</strong>
                    <p style="color: rgba(226, 232, 240, 0.7); margin-top: 5px;">${document.getElementById('customBackgroundMusic').selectedOptions[0] ? document.getElementById('customBackgroundMusic').selectedOptions[0].textContent : 'بدون موزیک'}</p>
                </div>
                <div style="background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(10px); padding: 20px; border-radius: 10px; border: 1px solid rgba(71, 85, 105, 0.3);">
                    <strong style="color: hsl(210, 40%, 98%);">🎨 زیرنویس:</strong>
                    <p style="color: rgba(226, 232, 240, 0.7); margin-top: 5px;">
                        رنگ: ${subtitleSettings.color} | سایز: ${subtitleSettings.size}px | حاشیه: ${subtitleSettings.outline}px
                    </p>
                </div>
            `;

            document.getElementById('summaryContainer').innerHTML = summary;
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function showProgress(percent, text) {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressContainer.style.display = 'block';
            progressFill.style.width = percent + '%';
            progressText.textContent = text;
        }

        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }

        async function generateVideo() {
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = '⏳ در حال ساخت...';

            try {
                // Collect scenes
                const sceneElements = document.querySelectorAll('.scene-item');
                const scenes = [];
                
                sceneElements.forEach((scene, index) => {
                    const text = scene.querySelector('.scene-text').value.trim();
                    const prompt = scene.querySelector('.scene-prompt').value.trim();
                    
                    scenes.push({
                        scene_number: index + 1,
                        speaker_text: text,
                        visual_description: prompt
                    });
                });

                showStatus('🎬 شروع ساخت ویدیو...', 'loading');
                showProgress(10, 'آماده‌سازی داده‌ها...');

                // Step 1: Generate images first using API
                showProgress(20, 'تولید تصاویر...');
                const images = [];
                
                for (let i = 0; i < scenes.length; i++) {
                    const scene = scenes[i];
                    
                    showProgress(20 + (i * 20 / scenes.length), `تولید تصویر ${i + 1} از ${scenes.length}...`);
                    
                    // Use API endpoint to generate and save image
                    const width = selectedOrientation === 'horizontal' ? 1920 : 1080;
                    const height = selectedOrientation === 'horizontal' ? 1080 : 1920;
                    
                    const imageResponse = await fetch('/api/flax/generate-image-url', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            prompt: scene.visual_description,
                            width: width,
                            height: height
                        })
                    });
                    
                    const imageResult = await imageResponse.json();
                    
                    if (imageResult.success) {
                        images.push({
                            sceneIndex: i,
                            imageUrl: imageResult.data.image_url
                        });
                    } else {
                        throw new Error(`خطا در تولید تصویر ${i + 1}: ${imageResult.error}`);
                    }
                }

                console.log('Images generated:', images);
                showProgress(40, 'تصاویر تولید شدند، در حال تولید صدا...');

                // Step 2: Generate video with generated images
                const selectedBackgroundMusic = document.getElementById('customBackgroundMusic').value;
                console.log('🎵 Custom video background music selected:', selectedBackgroundMusic);
                
                const response = await fetch('/api/video/generate-custom-video', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: 'ویدیوی سفارشی',
                        scenes: scenes,
                        voice: selectedVoice,
                        orientation: selectedOrientation,
                        subtitleSettings: subtitleSettings,
                        generatedImages: images,
                        backgroundMusic: selectedBackgroundMusic
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`خطا در تولید ویدئو: ${response.status} - ${errorText}`);
                }

                showProgress(90, 'در حال نهایی‌سازی...');
                
                const result = await response.json();

                if (result.success) {
                    // Check if video is queued (async processing) or completed (sync processing)
                    if (result.status === 'queued' || result.videoId) {
                        // Video added to queue - show queue message
                        showProgress(50, 'ویدیو به صف اضافه شد');
                        showStatus(`✅ ویدیو به صف اضافه شد (موقعیت: ${result.queuePosition || 'نامشخص'})`, 'success');

                        const videoResult = document.getElementById('videoResult');
                        videoResult.innerHTML = `
                            <div style="text-align: center; padding: 40px; background: rgba(59, 130, 246, 0.1); border-radius: 15px; margin-top: 20px;">
                                <h3 style="color: hsl(217, 91%, 60%); margin-bottom: 20px;">⏳ ویدیو در حال پردازش است</h3>
                                <p style="color: var(--text-primary); margin-bottom: 15px;">
                                    ویدیوی شما به صف اضافه شده و در حال پردازش در سرور است.
                                </p>
                                <p style="color: rgba(226, 232, 240, 0.7); margin-bottom: 20px;">
                                    <strong>شناسه ویدیو:</strong> ${result.videoId || 'نامشخص'}
                                </p>
                                <p style="color: rgba(226, 232, 240, 0.7); margin-bottom: 20px;">
                                    می‌توانید این صفحه را ببندید و بعداً از بخش 
                                    <a href="/video-queue.html" style="color: hsl(217, 91%, 60%); text-decoration: none;">صف ویدیوها</a>
                                    یا 
                                    <a href="/video-history.html" style="color: hsl(217, 91%, 60%); text-decoration: none;">تاریخچه</a>
                                    وضعیت آن را بررسی کنید.
                                </p>
                                <div style="margin-top: 30px;">
                                    <a href="/video-queue.html" class="btn" style="background: linear-gradient(135deg, hsl(217, 91%, 60%), rgba(168, 85, 247, 0.8)); color: white; padding: 12px 24px; border-radius: 10px; text-decoration: none; display: inline-block;">
                                        <i class="fas fa-list"></i> مشاهده صف ویدیوها
                                    </a>
                                </div>
                            </div>
                        `;
                        
                        videoResult.scrollIntoView({ behavior: 'smooth' });
                    } else if (result.data && result.data.video_url) {
                        // Video completed immediately (sync processing)
                        showProgress(100, 'تکمیل شد! ✅');
                        showStatus('🎉 ویدیو با موفقیت ساخته شد!', 'success');

                        const videoResult = document.getElementById('videoResult');
                        videoResult.innerHTML = `
                            <h3>📹 ویدیوی تولید شده:</h3>
                            <video controls style="max-width: 100%; height: auto; margin-top: 20px;">
                                <source src="${result.data.video_url}" type="video/mp4">
                                مرورگر شما از پخش ویدئو پشتیبانی نمی‌کند.
                            </video>
                            <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 10px; text-align: right;">
                                <p><strong>⏱️ مدت زمان:</strong> ${result.data.duration || 'نامشخص'} ثانیه</p>
                                <p><strong>📐 رزولوشن:</strong> ${result.data.resolution || 'نامشخص'}</p>
                                <p><strong>🎤 صدا:</strong> ${selectedVoice}</p>
                                <p><strong>📱 جهت:</strong> ${selectedOrientation === 'vertical' ? 'عمودی' : 'افقی'}</p>
                                <p><strong>🎭 تعداد صحنه‌ها:</strong> ${scenes.length}</p>
                            </div>
                        `;

                        videoResult.scrollIntoView({ behavior: 'smooth' });
                    } else {
                        throw new Error('فرمت پاسخ سرور نامعتبر است');
                    }
                } else {
                    throw new Error(result.error || 'خطا در تولید ویدئو');
                }

            } catch (error) {
                console.error('Error:', error);
                showStatus(`❌ خطا: ${error.message}`, 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '🎬 ساخت ویدیو نهایی';
                setTimeout(hideProgress, 3000);
            }
        }
    </script>
    <script src="ark-menu.js"></script>
</body>
</html>
